// backend/server.js
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const dotenv = require('dotenv');
const routes = require('./routes');

// === DEBUG NODEMAILER NO IN√çCIO ===
console.log('=== DEBUG NODEMAILER NO IN√çCIO ===');
try {
  const testNodemailer = require('nodemailer');
  console.log('‚úÖ Nodemailer carregado no in√≠cio!');
  console.log('Tipo de nodemailer:', typeof testNodemailer);
  console.log('createTransport √© fun√ß√£o?', typeof testNodemailer.createTransport);
} catch (e) {
  console.log('‚ùå Erro ao carregar nodemailer:', e.message);
}
console.log('================================');

// Carregar vari√°veis de ambiente
dotenv.config();

const app = express();

// üéØ CONFIGURA√á√ÉO SIMPLIFICADA PARA PRODU√á√ÉO
const isDevelopment = false; // For√ßar produ√ß√£o
const PORT = process.env.PORT || 8080; // Railway usa 8080 por padr√£o
const HOST = process.env.HOST || '0.0.0.0'; // IMPORTANTE para Railway

// üåç URLs PERMITIDAS (CORS) - PRODU√á√ÉO
const allowedOrigins = [
  'http://localhost:3000',                    // Desenvolvimento
  'http://localhost:3001',                    // Desenvolvimento backend
  'http://127.0.0.1:3000',                   // Desenvolvimento alternativo
  'https://the-safeswap.vercel.app',         // üéØ SEU VERCEL
  'https://the-safeswap-git-main.vercel.app', // Git branch do Vercel
  'https://the-safeswap.vercel.app/',        // Com trailing slash
];

// Remover URLs undefined/null
const cleanOrigins = allowedOrigins.filter(Boolean);

console.log('üîç Ambiente detectado:', isDevelopment ? 'DESENVOLVIMENTO' : 'PRODU√á√ÉO');
console.log('üåç CORS permitido para:', cleanOrigins);

// ================================
// üìß CONFIGURA√á√ÉO DO EMAIL (OPCIONAL)
// ================================

let transporter = null;
try {
  console.log('üîç Verificando configura√ß√£o de email...');
  console.log('EMAIL_USER:', process.env.EMAIL_USER ? '‚úÖ Configurado' : '‚ùå N√£o configurado');
  console.log('EMAIL_PASS:', process.env.EMAIL_PASS ? '‚úÖ Configurado' : '‚ùå N√£o configurado');
  
  if (process.env.EMAIL_USER && process.env.EMAIL_PASS) {
    const nodemailer = require('nodemailer');
    
    if (typeof nodemailer.createTransport === 'function') {
      transporter = nodemailer.createTransporter({
        service: 'gmail',
        auth: {
          user: process.env.EMAIL_USER,
          pass: process.env.EMAIL_PASS
        }
      });
      
      console.log('üìß Transporter criado, verificando conex√£o...');
      
      // Verificar conex√£o (sem bloquear o servidor)
      transporter.verify(function(error, success) {
        if (error) {
          console.log('‚ùå Erro ao verificar conex√£o Gmail:', error.message);
          transporter = null;
        } else {
          console.log('‚úÖ Conex√£o Gmail verificada com sucesso!');
        }
      });
    } else {
      console.log('‚ùå createTransport n√£o √© uma fun√ß√£o');
      transporter = null;
    }
  } else {
    console.log('‚ö†Ô∏è EMAIL_USER ou EMAIL_PASS n√£o encontrados no .env');
  }
} catch (error) {
  console.log('‚ùå Erro ao configurar email:', error.message);
  transporter = null;
}

// ================================
// üõ†Ô∏è MIDDLEWARES
// ================================

// üåç CORS CORRIGIDO
app.use(cors({
  origin: function (origin, callback) {
    // Permitir requests sem origin (mobile apps, postman, etc)
    if (!origin) return callback(null, true);
    
    // Verificar se a origin est√° na lista permitida
    if (cleanOrigins.indexOf(origin) !== -1) {
      return callback(null, true);
    }
    
    // Em desenvolvimento, ser mais permissivo
    if (isDevelopment) {
      console.log('üîì Permitindo origin em desenvolvimento:', origin);
      return callback(null, true);
    }
    
    // Em produ√ß√£o, bloquear origins n√£o autorizadas
    console.log('‚ùå Origin bloqueada:', origin);
    callback(new Error('N√£o permitido pelo CORS'));
  },
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(bodyParser.json({ limit: '10mb' }));
app.use(bodyParser.urlencoded({ extended: true, limit: '10mb' }));

// üìù Log de requisi√ß√µes
app.use((req, res, next) => {
  const timestamp = new Date().toISOString();
  console.log(`[${timestamp}] ${req.method} ${req.path}`);
  
  // Log do origin em produ√ß√£o para debug
  if (!isDevelopment && req.headers.origin) {
    console.log(`üåç Origin: ${req.headers.origin}`);
  }
  
  next();
});

// ================================
// üåê ROTAS
// ================================

// üîç Rota de health check para Railway
app.get('/health', (req, res) => {
  res.status(200).json({ 
    status: 'OK',
    timestamp: new Date().toISOString(),
    environment: isDevelopment ? 'development' : 'production',
    port: PORT
  });
});

// üìã Rota principal com informa√ß√µes da API
app.get('/', (req, res) => {
  res.json({ 
    message: 'üöÄ API do SafeSwap funcionando!',
    version: '1.0.0',
    environment: isDevelopment ? 'development' : 'production',
    timestamp: new Date().toISOString(),
    endpoints: {
      health: 'GET /health',
      createPixPayment: 'POST /api/create-pix-payment',
      processCardPayment: 'POST /api/process-card-payment',
      sendTicket: 'POST /api/send-ticket',
      checkPaymentStatus: 'GET /api/payment-status/:paymentId',
      webhook: 'POST /api/webhooks/mercadopago'
    },
    cors: {
      allowedOrigins: cleanOrigins.length,
      development: isDevelopment
    }
  });
});

// üìß Rota para enviar ingresso por email
app.post('/api/send-ticket', async (req, res) => {
  try {
    const { contactMethod, email, whatsapp, paymentData } = req.body;

    console.log('üìß Enviando ingresso:', { 
      contactMethod, 
      email: email ? email.substring(0, 3) + '***' : null,
      whatsapp: whatsapp ? whatsapp.substring(0, 3) + '***' : null
    });

    // Valida√ß√£o b√°sica
    if (!contactMethod || (!email && !whatsapp)) {
      return res.status(400).json({ 
        success: false, 
        message: 'Dados incompletos: contactMethod e email/whatsapp s√£o obrigat√≥rios' 
      });
    }

    // WhatsApp (simulado por enquanto)
    if (contactMethod === 'whatsapp') {
      console.log(`üì± WhatsApp ticket simulado para: ${whatsapp}`);
      return res.json({ 
        success: true, 
        message: 'Ticket enviado via WhatsApp (simulado)',
        ticketId: `SAFE-${Date.now().toString(36).toUpperCase()}`
      });
    }

    // Email
    if (contactMethod === 'email') {
      if (!email) {
        return res.status(400).json({ 
          success: false, 
          message: 'E-mail n√£o fornecido' 
        });
      }

      // Gerar c√≥digo do ingresso
      const ticketCode = `SAFE-${Date.now().toString(36).toUpperCase()}`;

      // Se nodemailer n√£o configurado, simular
      if (!transporter) {
        console.log(`üìß Email simulado para: ${email}`);
        return res.json({ 
          success: true, 
          message: 'Email enviado com sucesso! (simulado - configure EMAIL_USER e EMAIL_PASS no .env para envio real)',
          ticketId: ticketCode
        });
      }

      // Template do email
      const emailTemplate = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Seu Ingresso SafeSwap</title>
        </head>
        <body style="font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px;">
          <div style="max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px;">
            <h1 style="color: #14b8a6; text-align: center;">SafeSwap</h1>
            <h2 style="color: #333;">üé´ Seu Ingresso Chegou!</h2>
            <p>Parab√©ns! Seu ingresso SafeSwap foi gerado com sucesso.</p>
            
            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center; margin: 20px 0;">
              <h3 style="color: #14b8a6;">C√≥digo do Ingresso</h3>
              <p style="font-family: monospace; font-size: 20px; font-weight: bold; color: #333;">${ticketCode}</p>
            </div>

            ${paymentData ? `
            <div style="background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0;">
              <h4>Detalhes do Pagamento:</h4>
              <p><strong>Evento:</strong> ${paymentData.festa?.nome || 'SafeSwap Event'}</p>
              <p><strong>Valor:</strong> R$ ${paymentData.valor ? Number(paymentData.valor).toFixed(2) : '0,00'}</p>
              <p><strong>ID Pagamento:</strong> ${paymentData.paymentId || 'N/A'}</p>
            </div>
            ` : ''}
            
            <div style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 30px;">
              <p><strong>Informa√ß√µes Importantes:</strong></p>
              <ul>
                <li>Este ingresso √© √∫nico e intransfer√≠vel</li>
                <li>Apresente este e-mail na entrada do evento</li>
                <li>Guarde bem este comprovante</li>
              </ul>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 12px; margin-top: 30px;">
              SafeSwap - Ingressos Seguros<br>
              D√∫vidas: suporte@safeswap.com
            </p>
          </div>
        </body>
        </html>
      `;

      // Enviar email real
      const mailOptions = {
        from: `"SafeSwap" <${process.env.EMAIL_USER}>`,
        to: email,
        subject: 'üé´ Seu Ingresso SafeSwap',
        html: emailTemplate
      };

      await transporter.sendMail(mailOptions);
      console.log(`‚úÖ Email enviado para: ${email}`);
      
      return res.json({ 
        success: true, 
        message: 'Ingresso enviado com sucesso!',
        ticketId: ticketCode
      });
    }

  } catch (error) {
    console.error('‚ùå Erro ao enviar ingresso:', error);
    res.status(500).json({ 
      success: false, 
      message: 'Erro interno do servidor',
      details: isDevelopment ? error.message : 'Contate o suporte'
    });
  }
});

// ================================
// üîó USAR ROTAS DA API
// ================================

app.use(routes);

// ================================
// üõ°Ô∏è TRATAMENTO DE ERROS
// ================================

// Middleware de tratamento de erros
app.use((err, req, res, next) => {
  console.error('üí• Erro:', err.stack);
  
  res.status(err.status || 500).json({ 
    error: 'Algo deu errado!',
    message: isDevelopment ? err.message : 'Erro interno do servidor',
    status: err.status || 500,
    timestamp: new Date().toISOString()
  });
});

// Rota 404
app.use((req, res) => {
  console.log(`‚ùå Rota n√£o encontrada: ${req.method} ${req.path}`);
  res.status(404).json({ 
    error: 'Rota n√£o encontrada',
    message: `A rota ${req.method} ${req.path} n√£o existe`,
    availableRoutes: [
      'GET /',
      'GET /health',
      'POST /api/create-pix-payment',
      'POST /api/process-card-payment',
      'POST /api/send-ticket',
      'GET /api/payment-status/:paymentId'
    ]
  });
});

// ================================
// üöÄ INICIALIZA√á√ÉO
// ================================

// Iniciar servidor com host espec√≠fico para Railway
app.listen(PORT, HOST, () => {
  console.log('=================================');
  console.log(`üöÄ Servidor SafeSwap rodando!`);
  console.log(`üìç Host: ${HOST}`);
  console.log(`üîå Porta: ${PORT}`);
  console.log(`üåç Ambiente: ${isDevelopment ? 'DESENVOLVIMENTO' : 'PRODU√á√ÉO'}`);
  console.log(`üìÖ Iniciado em: ${new Date().toISOString()}`);
  console.log('=================================');
  
  // Status das configura√ß√µes
  console.log('üìä STATUS DAS CONFIGURA√á√ïES:');
  console.log(`üí≥ Mercado Pago: ${process.env.MERCADOPAGO_ACCESS_TOKEN ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}`);
  console.log(`üìß Email: ${transporter ? '‚úÖ Funcionando' : process.env.EMAIL_USER ? '‚ö†Ô∏è Parcial' : '‚ùå N√£o configurado'}`);
  console.log(`üåç CORS: ${cleanOrigins.length} origens permitidas`);
  
  if (isDevelopment) {
    console.log('üîì Modo desenvolvimento: CORS permissivo ativado');
  }
  
  console.log('=================================');
  console.log('üéØ API pronta para receber requisi√ß√µes!');
  console.log('=================================');
});

// üõ°Ô∏è Tratamento de erros n√£o capturados
process.on('unhandledRejection', (err) => {
  console.error('üí• Erro n√£o tratado (unhandledRejection):', err);
  if (!isDevelopment) {
    process.exit(1);
  }
});

process.on('uncaughtException', (err) => {
  console.error('üí• Exce√ß√£o n√£o capturada (uncaughtException):', err);
  process.exit(1);
});

// üì° Graceful shutdown
process.on('SIGTERM', () => {
  console.log('üì° SIGTERM recebido, finalizando servidor...');
  process.exit(0);
});

module.exports = app;